{% extends "admin/change_form.html" %}
{% load i18n %}

{% block extrahead %}{{ block.super }}
    <style>
        #judge-progress-container {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        #judge-progress-bar-container {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }
        #judge-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        #judge-progress-text {
            text-align: center;
            font-size: 14px;
            color: #333;
        }
        #auto-judge-container {
            margin-top: 10px;
            padding: 10px;
            background: #f0f8ff;
            border: 1px solid #b0d4f1;
            border-radius: 4px;
            display: none;
        }
        #auto-judge-container label {
            font-weight: normal;
            margin-left: 5px;
        }
        #auto-judge-container .help-text {
            display: block;
            margin-top: 5px;
            font-size: 12px;
            color: #666;
        }
    </style>
    <script>
        django.jQuery(function ($) {
            $('.rerate-link').appendTo('div#bottombar').show();
            $('.rejudge-link').click(function () {
                return confirm('{{ _('Are you sure you want to rejudge ALL the submissions?') }}');
            });
            $('.rescore-link').click(function () {
                return confirm('{{ _('Are you sure you want to rescore ALL the submissions?') }}');
            });
            $('.resend-link').click(function () {
                return confirm('{{ _('Are you sure you want to resend this announcement?') }}');
            });

            // Auto-judge checkbox for Final Submission Only format
            var $formatField = $('#id_format_name');
            var $formatConfigField = $('#id_format_config');

            if ($formatField.length === 0) {
                console.error('Format field not found!');
                return;
            }

            if ($formatConfigField.length === 0) {
                console.error('Format config field not found!');
                return;
            }

            var autoJudgeCheckboxHtml =
                '<div id="auto-judge-container" style="margin-top: 10px; padding: 10px; background: #f9f9f9; border: 1px solid #ddd;">' +
                '<label style="display: block; margin-bottom: 5px;">' +
                '<input type="checkbox" id="auto-judge-checkbox" checked style="margin-right: 5px;">' +
                '<strong>Tự động chấm điểm khi contest kết thúc</strong>' +
                '</label>' +
                '<p class="help" style="margin: 5px 0 0 20px; color: #666; font-size: 12px;">Nếu bỏ chọn, bạn sẽ phải bấm nút "Judge Final Submissions" để chấm điểm thủ công sau khi contest kết thúc.</p>' +
                '</div>';

            // Insert checkbox after format_config field's form-row
            var $formatConfigRow = $formatConfigField.closest('.form-row');
            if ($formatConfigRow.length) {
                $formatConfigRow.after(autoJudgeCheckboxHtml);
            } else {
                // Fallback: insert after the field itself
                $formatConfigField.after(autoJudgeCheckboxHtml);
            }

            var $autoJudgeContainer = $('#auto-judge-container');
            var $autoJudgeCheckbox = $('#auto-judge-checkbox');

            // Function to show/hide auto-judge checkbox based on format
            function updateAutoJudgeVisibility() {
                var selectedFormat = $formatField.val();
                if (selectedFormat === 'final_submission') {
                    $autoJudgeContainer.show();
                } else {
                    $autoJudgeContainer.hide();
                }
            }

            // Function to sync checkbox with format_config JSON
            function syncCheckboxFromConfig() {
                try {
                    var configValue = $formatConfigField.val().trim();
                    if (configValue) {
                        var config = JSON.parse(configValue);
                        var autoJudge = config.auto_judge !== undefined ? config.auto_judge : true;
                        $autoJudgeCheckbox.prop('checked', autoJudge);
                    } else {
                        $autoJudgeCheckbox.prop('checked', true);
                    }
                } catch (e) {
                    // If JSON is invalid, default to checked
                    $autoJudgeCheckbox.prop('checked', true);
                }
            }

            // Function to update format_config JSON from checkbox
            function updateConfigFromCheckbox() {
                if ($formatField.val() !== 'final_submission') {
                    return;
                }

                try {
                    var configValue = $formatConfigField.val().trim();
                    var config = configValue ? JSON.parse(configValue) : {};

                    // Update auto_judge in config
                    config.auto_judge = $autoJudgeCheckbox.is(':checked');

                    // Write back to field
                    $formatConfigField.val(JSON.stringify(config));
                } catch (e) {
                    // If JSON is invalid, create new config
                    var config = {
                        auto_judge: $autoJudgeCheckbox.is(':checked')
                    };
                    $formatConfigField.val(JSON.stringify(config));
                }
            }

            // Initialize from server-side value
            {% if auto_judge_enabled is not None %}
                $autoJudgeCheckbox.prop('checked', {{ auto_judge_enabled|lower }});
            {% endif %}

            // Initial visibility and sync
            updateAutoJudgeVisibility();
            if ($formatField.val() === 'final_submission') {
                syncCheckboxFromConfig();
            }

            // Listen to format change
            $formatField.change(function() {
                updateAutoJudgeVisibility();
                if ($(this).val() === 'final_submission') {
                    syncCheckboxFromConfig();
                }
            });

            // Listen to checkbox change
            $autoJudgeCheckbox.change(function() {
                updateConfigFromCheckbox();
            });

            // Before form submit, ensure config is updated
            $('form').submit(function() {
                if ($formatField.val() === 'final_submission') {
                    updateConfigFromCheckbox();
                }
            });

            // Handle Judge Final Submissions button
            var $judgeFinalBtn = $('.judge-final-link');
            var judgeProgressInterval = null;

            if ($judgeFinalBtn.length) {
                var pendingCount = parseInt($judgeFinalBtn.data('pending-count'));
                if (pendingCount > 0) {
                    $judgeFinalBtn.appendTo('div#bottombar').show();
                }
            }

            // Check if there's an ongoing judging task
            function checkJudgingProgress() {
                $.ajax({
                    url: '{% if original %}{% url "admin:judge_contest_judge_progress" original.pk %}{% endif %}',
                    method: 'GET',
                    success: function(data) {
                        if (data.status === 'in_progress') {
                            // Show progress bar
                            $('#judge-progress-container').show();
                            $('#judge-progress-bar').css('width', data.percent + '%');
                            $('#judge-progress-bar').text(data.percent + '%');
                            $('#judge-progress-text').text(
                                'Judging: ' + data.current + ' / ' + data.total +
                                ' (Judged: ' + data.judged_count + ')'
                            );
                        } else if (data.status === 'completed') {
                            // Show completion
                            $('#judge-progress-bar').css('width', '100%');
                            $('#judge-progress-bar').text('100%');
                            $('#judge-progress-text').text(
                                'Completed! Judged ' + data.judged_count + ' submissions.'
                            );

                            // Stop polling
                            if (judgeProgressInterval) {
                                clearInterval(judgeProgressInterval);
                                judgeProgressInterval = null;
                            }

                            // Reload page after 2 seconds
                            setTimeout(function() {
                                location.reload();
                            }, 2000);
                        } else if (data.status === 'failed') {
                            $('#judge-progress-text').text('Error: ' + data.error);
                            $('#judge-progress-bar').css('background', '#f44336');

                            if (judgeProgressInterval) {
                                clearInterval(judgeProgressInterval);
                                judgeProgressInterval = null;
                            }
                        } else if (data.status === 'no_task') {
                            // No task, hide progress bar
                            $('#judge-progress-container').hide();
                            if (judgeProgressInterval) {
                                clearInterval(judgeProgressInterval);
                                judgeProgressInterval = null;
                            }
                        }
                    },
                    error: function() {
                        if (judgeProgressInterval) {
                            clearInterval(judgeProgressInterval);
                            judgeProgressInterval = null;
                        }
                    }
                });
            }

            // Check on page load
            {% if original and original.format_name == 'final_submission' %}
                checkJudgingProgress();
            {% endif %}

            $judgeFinalBtn.click(function (e) {
                var pendingCount = parseInt($(this).data('pending-count'));
                var message = '{{ _('Are you sure you want to judge all pending submissions?') }}\n\n';
                message += '{{ _('Number of pending submissions:') }} ' + pendingCount;

                if (!confirm(message)) {
                    return false;
                }

                // Show progress bar immediately
                $('#judge-progress-container').show();
                $('#judge-progress-bar').css('width', '0%');
                $('#judge-progress-text').text('Starting judging task...');

                // Start polling after form submission
                setTimeout(function() {
                    judgeProgressInterval = setInterval(checkJudgingProgress, 2000);
                }, 1000);

                return true;
            });
        });
    </script>
{% endblock extrahead %}

{% block after_field_sets %}{{ block.super }}
    {% if original and original.is_rated and original.ended and perms.judge.contest_rating %}
        <a style="display: none" title="{% trans "Rate" %}" href="{% url 'admin:judge_contest_rate' original.pk %}"
           class="button rerate-link action-link">
            <i class="fa fa-lg fa-signal"></i>
            <span class="text">{% trans "Rate" %}</span>
        </a>
    {% endif %}

    {% if original and original.format_name == 'final_submission' %}
        <div id="judge-progress-container" style="display: none;">
            <h3>{% trans "Judging Progress" %}</h3>
            <div id="judge-progress-bar-container">
                <div id="judge-progress-bar">0%</div>
            </div>
            <p id="judge-progress-text">{% trans "Waiting for task to start..." %}</p>
        </div>

        {% if pending_submissions_count is not None %}
            <a style="display: none"
               title="{% trans "Judge Final Submissions" %}"
               href="{% url 'admin:judge_contest_judge_final' original.pk %}"
               class="button judge-final-link action-link"
               data-pending-count="{{ pending_submissions_count }}">
                <i class="fa fa-lg fa-gavel"></i>
                <span class="text">{% trans "Judge Final Submissions" %} ({{ pending_submissions_count }})</span>
            </a>
        {% endif %}
    {% endif %}
{% endblock %}
