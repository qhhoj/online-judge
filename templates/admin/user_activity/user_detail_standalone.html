<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä User Activity: {{ target_user.username }}</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --qhhoj-primary: #2c3e50;
            --qhhoj-secondary: #34495e;
            --qhhoj-accent: #3498db;
            --qhhoj-success: #27ae60;
            --qhhoj-warning: #f39c12;
            --qhhoj-danger: #e74c3c;
            --qhhoj-bg: #ecf0f1;
            --qhhoj-card-bg: #ffffff;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }

        .navbar {
            background: linear-gradient(135deg, var(--qhhoj-primary) 0%, var(--qhhoj-secondary) 100%) !important;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .navbar-brand {
            font-weight: bold;
            font-size: 1.3rem;
        }

        .container-fluid {
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card {
            border: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
            border-radius: 10px;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }

        .card-header {
            background: linear-gradient(135deg, var(--qhhoj-primary) 0%, var(--qhhoj-secondary) 100%);
            color: white;
            font-weight: 600;
            padding: 1rem 1.5rem;
        }

        .badge {
            font-size: 0.85em;
            padding: 0.4em 0.8em;
            border-radius: 5px;
        }

        .table th {
            background: linear-gradient(135deg, var(--qhhoj-primary) 0%, var(--qhhoj-secondary) 100%);
            color: white;
            border: none;
            font-weight: 600;
        }

        .activity-table tbody tr:hover {
            background-color: #f8f9fa;
            transform: scale(1.01);
            transition: all 0.2s ease;
        }

        .method-get { background-color: var(--qhhoj-success); }
        .method-post { background-color: var(--qhhoj-accent); }
        .method-put { background-color: var(--qhhoj-warning); color: #000; }
        .method-delete { background-color: var(--qhhoj-danger); }

        .pagination-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .error-404-section {
            background: linear-gradient(135deg, #fc4a1a 0%, #f7b733 100%);
            border-radius: 10px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .error-404-section h5 {
            color: white;
            font-weight: 600;
        }

        .nav-tabs .nav-link {
            color: var(--qhhoj-primary);
            font-weight: 600;
            border: none;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .nav-tabs .nav-link:hover {
            border-bottom-color: var(--qhhoj-accent);
        }

        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, var(--qhhoj-primary) 0%, var(--qhhoj-secondary) 100%);
            color: white;
            border-radius: 5px 5px 0 0;
        }

        .alert {
            border-radius: 10px;
            border: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-chart-line"></i> QHHOJ Admin
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/admin/user-activity/active-users/">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>üìä User Activity: <strong>{{ target_user.username }}</strong></h1>
            
            <!-- Filter Controls -->
            <div class="btn-toolbar" role="toolbar">
                <div class="btn-group me-2" role="group">
                    <a href="?days=7" class="btn btn-outline-primary {% if days_filter == 7 %}active{% endif %}">7 days</a>
                    <a href="?days=30" class="btn btn-outline-primary {% if days_filter == 30 %}active{% endif %}">30 days</a>
                    <a href="?days=90" class="btn btn-outline-primary {% if days_filter == 90 %}active{% endif %}">90 days</a>
                    <a href="?days=365" class="btn btn-outline-primary {% if days_filter == 365 %}active{% endif %}">1 year</a>
                    <a href="?days=-1" class="btn btn-outline-danger {% if days_filter == -1 %}active{% endif %}">All Time</a>
                </div>
            </div>
        </div>
        
        <!-- SUMMARY CARDS -->
        <div class="row mb-4">
            <div class="col-md-2">
                <div class="card text-white bg-primary">
                    <div class="card-body text-center">
                        <h5 class="card-title">üìä Total Activities</h5>
                        <h2>{{ total_activities }}</h2>
                        <small>{% if days_filter == -1 %}All Time{% else %}Last {{ days_filter }} days{% endif %}</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-white bg-success">
                    <div class="card-body text-center">
                        <h5 class="card-title">üîÑ Active Sessions</h5>
                        <h2>{{ active_session_count }}</h2>
                        <small>Live Now</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-white bg-info">
                    <div class="card-body text-center">
                        <h5 class="card-title">üì± Recent Sessions</h5>
                        <h2>{{ recent_session_count }}</h2>
                        <small>Last 7 days</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-white bg-warning">
                    <div class="card-body text-center">
                        <h5 class="card-title">üïò Total Sessions</h5>
                        <h2>{{ total_session_count }}</h2>
                        <small>All Sessions</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-white bg-secondary">
                    <div class="card-body text-center">
                        <h5 class="card-title">üåê Unique IPs</h5>
                        <h2>{{ ip_stats|length }}</h2>
                        <small>Different IPs</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-white bg-dark">
                    <div class="card-body text-center">
                        <h5 class="card-title">üìÑ Pages Visited</h5>
                        <h2>{{ path_stats|length }}</h2>
                        <small>Different Pages</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- USER STATUS -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="alert {% if active_session_count > 0 %}alert-success{% else %}alert-secondary{% endif %}" role="alert">
                    <h4 class="alert-heading">
                        {% if active_session_count > 0 %}
                            üü¢ User is Currently ONLINE
                        {% else %}
                            ‚ö´ User is Currently OFFLINE
                        {% endif %}
                    </h4>
                    <p class="mb-0">
                        {% if active_sessions %}
                            Last activity: {{ active_sessions.0.last_activity|timesince }} ago from {{ active_sessions.0.ip_address }}
                        {% elif all_sessions %}
                            Last seen: {{ all_sessions.0.last_activity|timesince }} ago from {{ all_sessions.0.ip_address }}
                        {% else %}
                            No activity recorded
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>

        <!-- NAVIGATION TABS -->
        <ul class="nav nav-tabs" id="userTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="activities-tab" data-bs-toggle="tab" data-bs-target="#activities" type="button" role="tab">
                    üìã Activities ({{ total_activities }})
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="sessions-tab" data-bs-toggle="tab" data-bs-target="#sessions" type="button" role="tab">
                    üì± Sessions ({{ total_session_count }})
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="stats-tab" data-bs-toggle="tab" data-bs-target="#stats" type="button" role="tab">
                    üìä Statistics
                </button>
            </li>
        </ul>

        <!-- TAB CONTENT -->
        <div class="tab-content mt-3" id="userTabContent">
            <!-- ACTIVITIES TAB -->
            <div class="tab-pane fade show active" id="activities" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h3>üìã Activity History ({{ total_activities }} total)</h3>
                        <span class="badge bg-info">{% if has_complete_history %}Complete History{% else %}Filtered History{% endif %}</span>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover activity-table">
                                <thead class="table-dark">
                                    <tr>
                                        <th>üïí Timestamp</th>
                                        <th>üìÑ Path</th>
                                        <th>üîß Method</th>
                                        <th>üåê IP Address</th>
                                        <th>üìä Response</th>
                                        <th>üñ•Ô∏è Browser</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for activity in activities %}
                                    <tr>
                                        <td>
                                            <small>{{ activity.timestamp|date:"m-d H:i:s" }}</small>
                                        </td>
                                        <td>
                                            <code style="font-size: 0.8em;">
                                                {% if activity.path|length > 40 %}
                                                    {{ activity.path|truncatechars:40 }}
                                                {% else %}
                                                    {{ activity.path }}
                                                {% endif %}
                                            </code>
                                        </td>
                                        <td>
                                            <span class="badge method-{{ activity.method|lower }}">
                                                {{ activity.method }}
                                            </span>
                                        </td>
                                        <td>
                                            <code style="font-size: 0.8em;">{{ activity.ip_address }}</code>
                                        </td>
                                        <td>
                                            {% if activity.response_code %}
                                                <span class="badge {% if activity.response_code < 300 %}bg-success{% elif activity.response_code < 400 %}bg-warning{% else %}bg-danger{% endif %}">
                                                    {{ activity.response_code }}
                                                </span>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if activity.session %}
                                                <small>{{ activity.session.browser|truncatechars:20 }}</small>
                                            {% else %}
                                                <small class="text-muted">N/A</small>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr><td colspan="6" class="text-center text-muted">No activities found for this period</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        {% if activities.has_other_pages %}
                        <div class="pagination-wrapper">
                            <div class="pagination-info">
                                Page {{ activities.number }} of {{ activities.paginator.num_pages }} 
                                ({{ activities.paginator.count }} total entries)
                            </div>
                            <nav>
                                <ul class="pagination">
                                    {% if activities.has_previous %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ activities.previous_page_number }}&days={{ days_filter }}">Previous</a>
                                        </li>
                                    {% endif %}
                                    
                                    {% for num in activities.paginator.page_range %}
                                        {% if num == activities.number %}
                                            <li class="page-item active">
                                                <span class="page-link">{{ num }}</span>
                                            </li>
                                        {% elif num > activities.number|add:'-3' and num < activities.number|add:'3' %}
                                            <li class="page-item">
                                                <a class="page-link" href="?page={{ num }}&days={{ days_filter }}">{{ num }}</a>
                                            </li>
                                        {% endif %}
                                    {% endfor %}
                                    
                                    {% if activities.has_next %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ activities.next_page_number }}&days={{ days_filter }}">Next</a>
                                        </li>
                                    {% endif %}
                                </ul>
                            </nav>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- SESSIONS TAB -->
            <div class="tab-pane fade" id="sessions" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h3>üì± User Sessions</h3>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>üåê IP Address</th>
                                        <th>üì± Device</th>
                                        <th>üñ•Ô∏è Browser</th>
                                        <th>üíª OS</th>
                                        <th>üïí Last Activity</th>
                                        <th>üîÑ Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for session in all_sessions %}
                                    <tr class="{% if session.is_active and session in active_sessions %}table-success{% endif %}">
                                        <td><code>{{ session.ip_address }}</code></td>
                                        <td>{{ session.device_type|title }}</td>
                                        <td>{{ session.browser|truncatechars:30 }}</td>
                                        <td>{{ session.os|truncatechars:20 }}</td>
                                        <td>
                                            <script>
                                                document.write(new Date('{{ session.last_activity|date:"c" }}').toLocaleString('vi-VN', {timeZone: 'Asia/Ho_Chi_Minh', year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit'}));
                                            </script>
                                        </td>
                                        <td>
                                            {% if session.is_active and session in active_sessions %}
                                                <span class="badge bg-success">üü¢ Active</span>
                                            {% else %}
                                                <span class="badge bg-secondary">‚ö´ Inactive</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr><td colspan="6" class="text-center text-muted">No sessions found</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- STATISTICS TAB -->
            <div class="tab-pane fade" id="stats" role="tabpanel">
                <div class="row">
                    <!-- IP Statistics -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h3>üåê Top IP Addresses</h3>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>IP Address</th>
                                                <th>Requests</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for stat in ip_stats %}
                                            <tr>
                                                <td><code>{{ stat.ip_address }}</code></td>
                                                <td><span class="badge bg-primary">{{ stat.count }}</span></td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Path Statistics -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h3>üìÑ Most Visited Pages</h3>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Path</th>
                                                <th>Visits</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for stat in path_stats %}
                                            <tr>
                                                <td>
                                                    <code style="font-size: 0.8em;">
                                                        {% if stat.path|length > 30 %}
                                                            {{ stat.path|truncatechars:30 }}
                                                        {% else %}
                                                            {{ stat.path }}
                                                        {% endif %}
                                                    </code>
                                                </td>
                                                <td><span class="badge bg-info">{{ stat.count }}</span></td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 404 Error Statistics Section -->
                {% if error_404_stats %}
                <div class="row mt-4">
                    <div class="col-md-12">
                        <div class="card error-404-section">
                            <div class="card-header" style="background: linear-gradient(135deg, #fc4a1a 0%, #f7b733 100%);">
                                <h3 style="color: white; margin: 0;">
                                    <i class="fas fa-exclamation-triangle"></i> 404 Not Found Errors
                                </h3>
                            </div>
                            <div class="card-body" style="background-color: rgba(255, 255, 255, 0.95);">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th style="background: linear-gradient(135deg, #fc4a1a 0%, #f7b733 100%);">Path</th>
                                                <th style="background: linear-gradient(135deg, #fc4a1a 0%, #f7b733 100%);">Error Count</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for stat in error_404_stats %}
                                            <tr>
                                                <td>
                                                    <code style="font-size: 0.8em; color: #e74c3c;">
                                                        {% if stat.path|length > 50 %}
                                                            {{ stat.path|truncatechars:50 }}
                                                        {% else %}
                                                            {{ stat.path }}
                                                        {% endif %}
                                                    </code>
                                                </td>
                                                <td>
                                                    <span class="badge" style="background-color: #e74c3c;">
                                                        {{ stat.count }} errors
                                                    </span>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Navigation -->
        <div class="mt-4 text-center">
            <a href="/admin/user-activity/active-users/" class="btn btn-primary">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
            <a href="/admin/user-activity/all-logs/" class="btn btn-secondary">
                <i class="fas fa-list"></i> All Logs
            </a>
            {% if total_activities and total_activities > 0 %}
            <a href="/admin/user-activity/delete-user-logs/{{ target_user.username }}/" 
               class="btn btn-danger" 
               onclick="return confirm('Are you sure you want to delete all logs for {{ target_user.username }}? This action cannot be undone.')">
                <i class="fas fa-trash"></i> Delete Logs
            </a>
            {% endif %}
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html> 